SET NOCOUNT ON;

IF OBJECT_ID('tempdb..#Columns') IS NOT NULL DROP TABLE #Columns;
IF OBJECT_ID('tempdb..#Indexes') IS NOT NULL DROP TABLE #Indexes;

CREATE TABLE #Columns
(
    DatabaseName sysname,
    SchemaName sysname,
    TableName sysname,
    ColumnName sysname,
    OrdinalPosition int,
    DataType sysname,
    MaxLength int,
    PrecisionValue int,
    ScaleValue int,
    IsNullable bit,
    ColumnSignature nvarchar(500)
);

CREATE TABLE #Indexes
(
    DatabaseName sysname,
    SchemaName sysname,
    TableName sysname,
    IndexName sysname,
    IsPrimaryKey bit,
    IsUnique bit,
    IndexTypeDesc nvarchar(60),
    KeyColumns nvarchar(max),
    IncludedColumns nvarchar(max),
    IndexSignature nvarchar(max)
);

DECLARE @sql nvarchar(max) = '';

SELECT @sql += '
USE ' + QUOTENAME(name) + ';
IF EXISTS (SELECT 1 FROM sys.tables WHERE name IN (''MSG_1'',''MSG_2'',''TradeXref''))
BEGIN
    INSERT INTO #Columns
    SELECT
        DB_NAME(),
        s.name,
        t.name,
        c.name,
        c.column_id,
        tp.name,
        c.max_length,
        c.precision,
        c.scale,
        c.is_nullable,
        tp.name + ''|'' +
        CAST(c.max_length AS varchar) + ''|'' +
        CAST(c.precision AS varchar) + ''|'' +
        CAST(c.scale AS varchar) + ''|'' +
        CAST(c.is_nullable AS varchar) + ''|'' +
        CAST(c.column_id AS varchar)
    FROM sys.tables t
    JOIN sys.schemas s ON t.schema_id = s.schema_id
    JOIN sys.columns c ON t.object_id = c.object_id
    JOIN sys.types tp ON c.user_type_id = tp.user_type_id
    WHERE t.name IN (''MSG_1'',''MSG_2'',''TradeXref'');

    INSERT INTO #Indexes
    SELECT
        DB_NAME(),
        s.name,
        t.name,
        i.name,
        i.is_primary_key,
        i.is_unique,
        i.type_desc,
        STUFF((
            SELECT '','' + c2.name +
                   CASE WHEN ic2.is_descending_key = 1 THEN '' DESC'' ELSE '' ASC'' END
            FROM sys.index_columns ic2
            JOIN sys.columns c2 
                 ON ic2.object_id = c2.object_id 
                AND ic2.column_id = c2.column_id
            WHERE ic2.object_id = i.object_id
              AND ic2.index_id = i.index_id
              AND ic2.is_included_column = 0
            ORDER BY ic2.key_ordinal
            FOR XML PATH(''''), TYPE).value(''.'',''nvarchar(max)'')
        ,1,1,''''),
        STUFF((
            SELECT '','' + c3.name
            FROM sys.index_columns ic3
            JOIN sys.columns c3 
                 ON ic3.object_id = c3.object_id 
                AND ic3.column_id = c3.column_id
            WHERE ic3.object_id = i.object_id
              AND ic3.index_id = i.index_id
              AND ic3.is_included_column = 1
            FOR XML PATH(''''), TYPE).value(''.'',''nvarchar(max)'')
        ,1,1,''''),
        i.type_desc + ''|'' +
        CAST(i.is_unique AS varchar) + ''|'' +
        CAST(i.is_primary_key AS varchar) + ''|'' +
        ISNULL(STUFF((
            SELECT '','' + c2.name +
                   CASE WHEN ic2.is_descending_key = 1 THEN '' DESC'' ELSE '' ASC'' END
            FROM sys.index_columns ic2
            JOIN sys.columns c2 
                 ON ic2.object_id = c2.object_id 
                AND ic2.column_id = c2.column_id
            WHERE ic2.object_id = i.object_id
              AND ic2.index_id = i.index_id
              AND ic2.is_included_column = 0
            ORDER BY ic2.key_ordinal
            FOR XML PATH(''''), TYPE).value(''.'',''nvarchar(max)'')
        ,1,1,''''),'''') + ''|'' +
        ISNULL(STUFF((
            SELECT '','' + c3.name
            FROM sys.index_columns ic3
            JOIN sys.columns c3 
                 ON ic3.object_id = c3.object_id 
                AND ic3.column_id = c3.column_id
            WHERE ic3.object_id = i.object_id
              AND ic3.index_id = i.index_id
              AND ic3.is_included_column = 1
            FOR XML PATH(''''), TYPE).value(''.'',''nvarchar(max)'')
        ,1,1,''''),'''')
    FROM sys.tables t
    JOIN sys.schemas s ON t.schema_id = s.schema_id
    JOIN sys.indexes i ON t.object_id = i.object_id
    WHERE t.name IN (''MSG_1'',''MSG_2'',''TradeXref'')
      AND i.type > 0;
END;
'
FROM sys.databases
WHERE database_id > 4 AND state_desc = 'ONLINE';

EXEC sp_executesql @sql;

-------------------------------------------------------
-- COLUMN DRIFT (Most common definition baseline)
-------------------------------------------------------

;WITH ColumnFrequency AS
(
    SELECT *,
           COUNT(*) OVER (PARTITION BY SchemaName, TableName, ColumnName, ColumnSignature) AS SignatureCount,
           ROW_NUMBER() OVER (
               PARTITION BY SchemaName, TableName, ColumnName
               ORDER BY COUNT(*) OVER (PARTITION BY SchemaName, TableName, ColumnName, ColumnSignature) DESC
           ) AS rn
    FROM #Columns
),
BaselineColumns AS
(
    SELECT *
    FROM ColumnFrequency
    WHERE rn = 1
)
SELECT 
    c.DatabaseName,
    c.SchemaName,
    c.TableName,
    c.ColumnName,
    'Column Drift' AS IssueType,
    c.ColumnSignature AS CurrentDefinition,
    b.ColumnSignature AS BaselineDefinition
FROM #Columns c
JOIN BaselineColumns b
     ON c.SchemaName = b.SchemaName
    AND c.TableName = b.TableName
    AND c.ColumnName = b.ColumnName
WHERE c.ColumnSignature <> b.ColumnSignature
ORDER BY c.SchemaName, c.TableName, c.ColumnName;

-------------------------------------------------------
-- INDEX DRIFT (Most common structure baseline)
-------------------------------------------------------

;WITH IndexFrequency AS
(
    SELECT *,
           COUNT(*) OVER (PARTITION BY SchemaName, TableName, IndexSignature) AS SigCount,
           ROW_NUMBER() OVER (
               PARTITION BY SchemaName, TableName
               ORDER BY COUNT(*) OVER (PARTITION BY SchemaName, TableName, IndexSignature) DESC
           ) AS rn
    FROM #Indexes
),
BaselineIndexes AS
(
    SELECT *
    FROM IndexFrequency
    WHERE rn = 1
)
SELECT
    i.DatabaseName,
    i.SchemaName,
    i.TableName,
    i.IndexName,
    'Index Drift' AS IssueType,
    i.IndexSignature AS CurrentDefinition,
    b.IndexSignature AS BaselineDefinition
FROM #Indexes i
JOIN BaselineIndexes b
     ON i.SchemaName = b.SchemaName
    AND i.TableName = b.TableName
WHERE i.IndexSignature <> b.IndexSignature
ORDER BY i.SchemaName, i.TableName, i.IndexName;
